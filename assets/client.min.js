let $=e=>document.getElementById(e),encoder=new TextEncoder,decoder=new TextDecoder("utf-8",{fatal:!1}),HKDF_INFO_ID=encoder.encode("blob-id"),ID_REGEX=/^[A-Za-z0-9_-]{16,}$/,KEY_SIZE=32,NONCE_SIZE=12,SALT_SIZE=16,ID_SIZE=16,BLOB_TYPE_SIZE=2,BLOB_TYPE_TEXT=new Uint8Array([19,55]),BLOB_TYPE_PASSWORD=new Uint8Array([115,55]),BLOB_TYPE_TEXT_VALUE=4919,BLOB_TYPE_PASSWORD_VALUE=29495,MAX_BLOB_SIZE=131072,PBKDF2_ITERATIONS=2e5,PBKDF2_HASH="SHA-256",HKDF_HASH="SHA-256",QRCODE_SIZE=220,QRCODE_BORDER=10,QRCODE_CORRECT_LEVEL=1,state={id:null,bK:null,link:null,qrVisible:!1,pendingSecret:null,originalPlaceholder:null},qrInstance=null,STATUS_ICON_PATHS={success:'<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>',error:'<path d="M12 7v7" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17h.01" stroke-linecap="round" stroke-linejoin="round"/>',info:'<path d="M12 8h.01" stroke-linecap="round" stroke-linejoin="round"/><path d="M11 12h1v4h1" stroke-linecap="round" stroke-linejoin="round"/>'},isMacLike="undefined"!=typeof navigator&&/(Mac|iPhone|iPad|iPod)/i.test(navigator.platform||navigator.userAgent||"");function normalizeOrigin(e){return e.replace(/\/+$/,"")}function clearLocationHash(){if("undefined"!=typeof window)try{var e;"undefined"!=typeof history&&"function"==typeof history.replaceState?(e=window.location.pathname+window.location.search,history.replaceState(null,"",e)):window.location.hash=""}catch{window.location.hash=""}}function setStatus(e,t=!1){var r=$("statusNotification"),n=$("statusMessage"),a=$("heroSubtitle"),i=$("statusIcon"),i=i?i.querySelector(".status-icon-graphic"):null,s=$("progressBar");e?(n.textContent=e,r.classList.add("is-visible"),r.classList.toggle("is-success",!!t),r.classList.toggle("is-error",!t),a.classList.add("is-hidden"),e=t?"success":"error",i.innerHTML=STATUS_ICON_PATHS[e]||STATUS_ICON_PATHS.info||"",s.style.transition="none",s.style.width="0%",s.offsetWidth,s.style.transition="",s.style.width="100%"):(n.textContent="",r.classList.remove("is-visible","is-success","is-error"),s.style.width="0%",i.innerHTML="",a.classList.remove("is-hidden"))}function clearPendingSecret(){var e=state.pendingSecret;e&&(e.ciphertext&&e.ciphertext.fill(0),e.nonce&&e.nonce.fill(0),e.salt&&e.salt.fill(0),state.pendingSecret=null)}function setDecryptionCardVisible(e){var t=$("decryptionCard"),r=$("encryptionCard");e?(t.classList.add("is-visible"),r.classList.remove("is-visible")):(t.classList.remove("is-visible"),r.classList.add("is-visible"),(e=$("decryptionPassword"))&&(e.value=""))}function lockTextarea(e){var t,r=$("text");null===state.originalPlaceholder&&(t=r.getAttribute("placeholder"),state.originalPlaceholder="string"==typeof t?t:""),e?(r.classList.add("textarea-locked"),r.setAttribute("readonly","true"),r.setAttribute("placeholder","Secret will appear here after you decrypt it.")):(r.classList.remove("textarea-locked"),r.removeAttribute("readonly"),null!==state.originalPlaceholder&&(""===state.originalPlaceholder?r.removeAttribute("placeholder"):r.setAttribute("placeholder",state.originalPlaceholder))),r.dispatchEvent(new Event("input",{bubbles:!0}))}function cloneBytes(e){var t;return e instanceof Uint8Array?((t=new Uint8Array(e.length)).set(e),t):null}function bytesToHex(t){let r="";for(let e=0;e<t.length;e++)r+=t[e].toString(16).padStart(2,"0");return r}function equal16B(e,t){e=new Uint32Array(e.buffer,e.byteOffset,4),t=new Uint32Array(t.buffer,t.byteOffset,4);return!(e[0]^t[0]|e[1]^t[1]|e[2]^t[2]|e[3]^t[3])}function updateQr(){var t=$("qrWrap"),r=$("qrCode");if(t&&r){var n=state.link;if(state.qrVisible&&n)try{if("function"!=typeof window.QRCode)throw new Error("QR renderer unavailable");qrInstance?"function"==typeof qrInstance.clear&&qrInstance.clear():qrInstance=new QRCode(r,{width:QRCODE_SIZE,height:QRCODE_SIZE,border:QRCODE_BORDER,colorDark:"#000000",colorLight:"#ffffff",correctLevel:0==QRCODE_CORRECT_LEVEL?QRCode.CorrectLevel.L:QRCode.CorrectLevel.H}),qrInstance.makeCode(n),t.style.display="flex"}catch(e){console.error(e),t.style.display="none",qrInstance&&"function"==typeof qrInstance.clear&&qrInstance.clear(),r.innerHTML="",qrInstance=null,state.qrVisible=!1;n=$("btnGenerateQr");n&&(n.textContent="Generate QR"),setStatus(e.message||String(e))}else t.style.display="none",qrInstance&&"function"==typeof qrInstance.clear&&qrInstance.clear(),r.innerHTML="",qrInstance=null}}function setLink(r,n,a){let i=$("generatedWrap"),s=$("generatedUrl"),l=$("btnCopyLink"),o=$("btnGenerateQr");var c=()=>{state.id=null,state.bK=null,state.link=null,state.qrVisible=!1,i&&(i.style.display="none"),s&&(s.value=""),l&&(l.style.display="none"),o&&(o.style.display="none",o.textContent="Generate QR")};if(r&&n&&a){let e=null,t=null;try{var d=normalizeOrigin(r);if(!(e=base64UrlDecode(a))||e.length!==KEY_SIZE)throw new Error("Key length mismatch");if(!(t=base64UrlDecode(n))||t.length!==ID_SIZE)throw new Error("ID length mismatch");var u=base64UrlEncode(e),p=base64UrlEncode(t),y=(state.link=d+"/#"+p+"/"+u,state.id=p,state.bK=u,i&&(i.style.display="flex"),s&&(s.value=state.link),l&&(l.style.display="inline-block"),$("host"));y&&(y.value=d)}catch(e){return console.error(e),setStatus(e.message||String(e)),c(),void updateQr()}finally{e&&e.fill(0),t&&t.fill(0)}o&&(o.style.display=state.link?"inline-block":"none",o.textContent=state.qrVisible?"Hide QR":"Generate QR")}else c();updateQr()}function getOrigin(){var e=$("host"),t=(6<e.value.length?e.value:"https://local.tanuki-gecko.ts.net").trim();if(!t)throw new Error("Service origin is empty");let r;try{r=new URL(t)}catch{throw new Error("Invalid service origin URL")}if(r.username||r.password)throw new Error("Origin must not include credentials");if(r.pathname&&"/"!==r.pathname||r.search||r.hash)throw new Error("Origin must not include path, query, or fragment");var t="localhost"===r.hostname||"127.0.0.1"===r.hostname||"::1"===r.hostname;if("https:"===r.protocol||t)return t=r.origin,e&&e.value!==t&&(e.value=t),t;throw new Error("Service origin must use https://")}function base64UrlEncode(t){if(!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");let r="";for(let e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function base64UrlDecode(e){try{var t=e.replace(/-/g,"+").replace(/_/g,"/"),r=t.length%4,n=t+(r?"====".slice(r):""),a=atob(n),i=new Uint8Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);return i}catch(e){throw new Error("Invalid base64 data")}}async function deriveIdFromKeyAndSalt(e,t){e=await crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveBits"]),t=await crypto.subtle.deriveBits({name:"HKDF",hash:HKDF_HASH,salt:t,info:HKDF_INFO_ID},e,8*ID_SIZE);return new Uint8Array(t)}async function derivePasswordKey(e,t,r){e=encoder.encode(e);let n;try{n=await crypto.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"])}finally{e.fill(0)}e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:t,iterations:PBKDF2_ITERATIONS,hash:PBKDF2_HASH},n,8*KEY_SIZE),t=new Uint8Array(e),e=await crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:8*KEY_SIZE},!1,r);return t.fill(0),e}function parseLocationHash(e){if(!e)return null;let t=e.trim();try{var r=new URL(t);t=r.hash||""}catch{}var e=(t=t.startsWith("#")?t.slice(1):t).indexOf("#"),r=(t=(t=0<=e?t.slice(e+1):t).replace(/^\/+/,"")).split("/");return 2===r.length&&(e=r[0].trim(),r=r[1].trim(),e)&&r&&ID_REGEX.test(e)&&r?{id:e,bK:r}:null}async function sendSecret(e=!1){setStatus(""),clearPendingSecret(),lockTextarea(!0);let t=null,r=null,n=null,a=null,i=null,s=null,l=null,o=null;var c;try{var d,u,p=getOrigin(),y=$("text"),h=$("optionalPassword"),f=h.value,E="string"==typeof f&&0<f.length,w=(i=encoder.encode(y.value),t=crypto.getRandomValues(new Uint8Array(KEY_SIZE)),r=crypto.getRandomValues(new Uint8Array(NONCE_SIZE)),n=crypto.getRandomValues(new Uint8Array(SALT_SIZE)),c=base64UrlEncode(a=await deriveIdFromKeyAndSalt(t,n)),encoder.encode("id="+c)),v=(E&&(d=await derivePasswordKey(f,n,["encrypt"]),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:w},d,i),i.fill(0),i=new Uint8Array(u)),E?BLOB_TYPE_PASSWORD:BLOB_TYPE_TEXT),S=((s=new Uint8Array(BLOB_TYPE_SIZE+i.length)).set(v,0),s.set(i,BLOB_TYPE_SIZE),await crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:8*KEY_SIZE},!1,["encrypt"]));if(l=new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:w},S,s)),s.fill(0),s=null,i.fill(0),i=null,(o=new Uint8Array(r.length+n.length+l.length)).set(r,0),o.set(n,r.length),o.set(l,r.length+n.length),o.length>MAX_BLOB_SIZE)return void setStatus("Secret is too large. Maximum size is 1 MiB.",!1);var g,b=normalizeOrigin(p)+"/blob/"+bytesToHex(a),L=await fetch(b,{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:o});if(!L.ok)throw g=await safeText(L),new Error(`POST ${b} ${L.status}: `+(g||L.statusText));h.value="";setLink(p,c,base64UrlEncode(t));var m=E?" This secret requires the password you set during creation.":"";if(e&&state.link)try{if("undefined"==typeof navigator||!navigator.clipboard||"function"!=typeof navigator.clipboard.writeText)throw new Error("Clipboard API unavailable");await navigator.clipboard.writeText(state.link),setStatus("Secret stored and the share link was copied to your clipboard automatically."+m,!0)}catch(e){console.error(e),setStatus("Secret stored, but automatic link copy failed. Use the copy button above."+m,!0)}else setStatus("Secret stored. Share the generated link."+m,!0)}catch(e){console.error(e),setStatus(e.message||String(e))}finally{i&&i.fill(0),s&&s.fill(0),l&&l.fill(0),o&&o.fill(0),t&&t.fill(0),r&&r.fill(0),n&&n.fill(0),a&&a.fill(0)}lockTextarea(!1)}async function copyLink(){try{state.link?(await navigator.clipboard.writeText(state.link),setStatus("Link copied to clipboard.",!0),setTimeout(()=>{state.link&&setStatus("")},1200)):setStatus("No link available to copy.",!1)}catch(e){setStatus("Could not copy link: "+(e.message||e),!1)}}async function safeText(e){try{return await e.text()}catch{return""}}async function tryToReceiveSecret(){var i=parseLocationHash(window.location.hash||"");if(i){clearLocationHash(),clearPendingSecret(),lockTextarea(!0);let e=null,t=null,r=null,n=null,a=null;try{var s=getOrigin();if((e=base64UrlDecode(i.bK)).length!==KEY_SIZE)throw new Error("Key length mismatch");if(!(n=base64UrlDecode(i.id))||n.length!==ID_SIZE)throw new Error("ID length mismatch");setStatus("Fetching secret…");var l,o=normalizeOrigin(s)+"/blob/"+bytesToHex(n),c=await fetch(o);if(!c.ok)throw l=await safeText(c),new Error(`GET ${o} ${c.status}: `+(l||c.statusText));if((t=new Uint8Array(await c.arrayBuffer())).length<=NONCE_SIZE+SALT_SIZE+BLOB_TYPE_SIZE)throw new Error("Blob is too small");var d,u,p=t.subarray(0,NONCE_SIZE),y=t.subarray(NONCE_SIZE,NONCE_SIZE+SALT_SIZE),h=t.subarray(NONCE_SIZE+SALT_SIZE);if(!equal16B(a=await deriveIdFromKeyAndSalt(e,y),n))throw d=base64UrlEncode(a),(u=new Error(`ID mismatch: derived ID' (${d}) !== provided ID (${i.id}).`)).name="IdMismatchError",u.derivedId=d,u.providedId=i.id,u;var f=await crypto.subtle.importKey("raw",e,{name:"AES-GCM",length:8*KEY_SIZE},!1,["decrypt"]),E=encoder.encode("id="+i.id);if((r=new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:p,additionalData:E},f,h))).length<BLOB_TYPE_SIZE)throw new Error("Decrypted payload missing type tag");var w=r[0]<<8|r[1],v=w===BLOB_TYPE_PASSWORD_VALUE;if(!v&&w!==BLOB_TYPE_TEXT_VALUE)throw new Error("Unsupported blob type");var S=r.subarray(BLOB_TYPE_SIZE);if(v){var g=cloneBytes(p),b=cloneBytes(y),L=cloneBytes(S);if(!g||!b||!L)throw new Error("Failed to prepare password protected payload");state.pendingSecret={id:i.id,nonce:g,salt:b,ciphertext:L},r.fill(0),setDecryptionCardVisible(!(r=null)),setStatus("Password required to decrypt this secret.",!1);var m=$("decryptionPassword");m&&(m.value="",m.focus())}else{var _=$("text");_.value=decoder.decode(S),_.dispatchEvent(new Event("input",{bubbles:!0})),setStatus("Secret retrieved and decrypted.",!0)}}catch(e){console.error(e),setDecryptionCardVisible(!1),setStatus(e.message||String(e)),clearPendingSecret()}finally{r&&r.fill(0),e&&e.fill(0),n&&n.fill(0),a&&a.fill(0),t&&t.fill(0),lockTextarea(!1)}}}async function decryptPendingSecretWithPassword(){var t=state.pendingSecret;if(t&&t.ciphertext){var r=$("decryptionPassword"),n=r.value;if(n){let e=null;try{setStatus("Decrypting secret with provided password…");var a=await derivePasswordKey(n,t.salt,["decrypt"]),i=encoder.encode("id="+t.id),s=(e=new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:t.nonce,additionalData:i},a,t.ciphertext)),$("text"));s.value=decoder.decode(e),s.dispatchEvent(new Event("input",{bubbles:!0})),setStatus("Secret decrypted with the provided password.",!(r.value="")),setDecryptionCardVisible(!1)}catch(e){console.error(e),setStatus("Could not decrypt with that password.",!1),r.select(),r.focus()}finally{clearPendingSecret(),e&&e.fill(0)}}else setStatus("Enter the password to decrypt this secret.",!1),r.focus()}else setStatus("No secret waiting for password decryption.",!1)}let hostInput=$("host");if(hostInput)try{let e=window.location.origin;e&&"null"!==e&&(hostInput.value=e)}catch(e){}$("btnGetLink").addEventListener("click",()=>{sendSecret(!1)}),$("btnCopyLink").addEventListener("click",copyLink);let optionalPasswordField=$("optionalPassword"),textArea=$("text");if(null===state.originalPlaceholder){let e=textArea.getAttribute("placeholder");state.originalPlaceholder="string"==typeof e?e:""}textArea.addEventListener("keydown",e=>{var t=isMacLike?e.metaKey:e.ctrlKey;"Enter"===e.key&&t&&(e.repeat||sendSecret(!0),e.preventDefault())}),optionalPasswordField.addEventListener("keydown",e=>{var t=isMacLike?e.metaKey:e.ctrlKey;"Enter"===e.key&&t&&(e.repeat||sendSecret(!0),e.preventDefault())});let decryptBtn=$("decryptBtn"),passwordField=(decryptBtn.addEventListener("click",()=>{decryptPendingSecretWithPassword()}),$("decryptionPassword")),qrButton=(passwordField.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),decryptPendingSecretWithPassword())}),$("btnGenerateQr")),closeStatusBtn=(qrButton.addEventListener("click",()=>{state.link?(state.qrVisible=!state.qrVisible,updateQr(),qrButton.textContent=state.qrVisible?"Hide QR":"Generate QR",state.qrVisible&&setStatus("QR code generated.",!0)):setStatus("Generate a link first.")}),$("closeStatus"));closeStatusBtn.addEventListener("click",()=>{setStatus("")}),$("host").addEventListener("change",()=>{if(state.id&&state.bK)try{setLink(getOrigin(),state.id,state.bK)}catch{}}),document.addEventListener("DOMContentLoaded",function(){let s=document.getElementById("text"),r=document.querySelector(".nav-toggle"),n=document.querySelector(".nav-links");if(s){let r=document.createElement("div"),n="function"==typeof TextEncoder?new TextEncoder:null,a=MAX_BLOB_SIZE-100,i=(a/1024).toFixed(2);r.classList.add("char-counter"),s.parentNode.appendChild(r);var e=()=>{var e=s.value||"",e=(n?n.encode(e):e).length,t=(e/1024).toFixed(2);r.textContent=i?`${t} of ${i} KiB`:t+" KiB",r.classList.remove("warning","danger"),a&&(.9<(t=e/a)?r.classList.add("danger"):.8<t&&r.classList.add("warning"))};s.addEventListener("input",e),e()}if(r&&n){let t=()=>{n.classList.contains("is-open")&&(n.classList.remove("is-open"),r.classList.remove("is-active"))};r.addEventListener("click",()=>{var e=n.classList.toggle("is-open");r.classList.toggle("is-active",e)}),n.addEventListener("click",e=>{e.target.classList.contains("nav-link")&&t()}),document.addEventListener("click",e=>{n.contains(e.target)||r.contains(e.target)||t()}),window.addEventListener("resize",()=>{768<window.innerWidth&&(n.classList.remove("is-open"),r.classList.remove("is-active"))})}}),tryToReceiveSecret();